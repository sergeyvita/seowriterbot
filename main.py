from flask import Flask, request, jsonify
from openai import OpenAI
import os
import re

app = Flask(__name__)

api_key = os.environ.get("OPENAI_API_KEY")
client = OpenAI(api_key=api_key)

@app.route("/generate", methods=["POST"])
def generate():
    try:
        data = request.get_json()
        chunks = data.get("chunks", [])
        prompt_text = "\n\n".join(chunks)

        full_prompt = f"""
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä, —Å–æ–∑–¥–∞—é—â–∏–π —Å—Ç–∞—Ç—å–∏ –æ –∂–∏–ª—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–∞—Ö –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ —Å–∞–π—Ç–µ –∏ –≤ –Ø–Ω–¥–µ–∫—Å.–î–∑–µ–Ω–µ. –ù–∞–ø–∏—à–∏ —Å—Ç–∞—Ç—å—é –æ –∂–∏–ª–æ–º –∫–æ–º–ø–ª–µ–∫—Å–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –Ω–µ –ø—Ä–µ–¥—É–º—ã–≤–∞–π –∏ –Ω–µ —Ñ–∞–Ω—Ç–∞–∑–∏—Ä—É–π.
1. –¶–µ–ª—å —Å—Ç–∞—Ç—å–∏: —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º –æ –∂–∏–ª–æ–º –∫–æ–º–ø–ª–µ–∫—Å–µ, –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞—Ç—å, –≤—ã–∑–≤–∞—Ç—å –¥–æ–≤–µ—Ä–∏–µ, –ø–µ—Ä–µ–¥–∞—Ç—å —ç–º–æ—Ü–∏–∏ –æ—Ç –±—É–¥—É—â–µ–π –∂–∏–∑–Ω–∏ –≤ —ç—Ç–æ–º –ñ–ö –∏ –º—è–≥–∫–æ –ø–æ–¥—Ç–æ–ª–∫–Ω—É—Ç—å –∫ –¥–µ–π—Å—Ç–≤–∏—é (–ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç –∏–ª–∏ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –æ—Ç–¥–µ–ª–æ–º –ø—Ä–æ–¥–∞–∂).
2. –¢–æ–Ω: —Ç—ë–ø–ª—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π.
3. –°—Ç–∏–ª—å: —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π, –ø—Ä–æ—Å—Ç–æ–π, –ª–µ–≥–∫–æ —á–∏—Ç–∞–µ—Ç—Å—è –Ω–∞ –ª—é–±–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.
4. –û–±—Ä–∞—â–µ–Ω–∏–µ: –æ—Ç –≤—Ç–æ—Ä–æ–≥–æ –ª–∏—Ü–∞ (—Ç—ã, –≤—ã), —Å –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ–º —á–∏—Ç–∞—Ç–µ–ª—è, –±–µ–∑ –æ—Ñ–∏—Ü–∏–æ–∑–∞.
5. –î–ª–∏–Ω–∞: –¥–æ 4000 —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –ñ–ö
6. –°—Ç–∞—Ç—å—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∞ –≤—Ä—É—á–Ω—É—é ‚Äî –±–µ–∑ —à–∞–±–ª–æ–Ω–Ω–æ—Å—Ç–∏ –∏ –∫–ª–∏—à–µ.

7.  –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç–∞—Ç—å–∏:
- –ó–∞–≥–æ–ª–æ–≤–æ–∫: —Ü–µ–ø–ª—è—é—â–∏–π, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π, —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ñ–ö.
- –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ: –æ–±—Ä–∞–∑–Ω–∞—è –ø–æ–¥–∞—á–∞, –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ –≤ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, –∫–∞–∫‚Ä¶¬ª).
- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è: —Ü–µ–Ω—Ç—Ä, –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, —É–ª–∏—Ü—ã –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏.
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –¥–∏–∑–∞–π–Ω: —Ñ–∞—Å–∞–¥—ã, –æ—Å—Ç–µ–∫–ª–µ–Ω–∏–µ, –±–∞–ª–∫–æ–Ω—ã, –≤–Ω–µ—à–Ω–∏–π —Å—Ç–∏–ª—å.
- –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —É–¥–æ–±—Å—Ç–≤–∞: —à–∫–æ–ª—ã, –¥–µ—Ç—Å–∞–¥—ã, –∫–æ–≤–æ—Ä–∫–∏–Ω–≥–∏, –ø–∞—Ä–∫–∏–Ω–≥, –æ—Ö—Ä–∞–Ω–∞, –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ, –∑–æ–Ω—ã –æ—Ç–¥—ã—Ö–∞, –¥–≤–æ—Ä-–ø–∞—Ä–∫.
- –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∏: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è, –º–∞—Å—Ç–µ—Ä-—Å–ø–∞–ª—å–Ω–∏, –ø–µ–Ω—Ç—Ö–∞—É—Å—ã.
- –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ, FACE ID, –æ—Ö—Ä–∞–Ω–∞, –ª–∏—Ñ—Ç—ã, –∫–ª–∞–¥–æ–≤—ã–µ.
- –û—Ç–¥–µ–ª–∫–∞ –∏ —Ä–µ–º–æ–Ω—Ç: –ø—Ä–µ–¥—á–∏—Å—Ç–æ–≤–∞—è, –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–¥–µ–ª–∫–∏ –æ—Ç –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞.
- –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å: —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ 214-–§–ó, —ç—Å–∫—Ä–æ—É-—Å—á–µ—Ç–∞.
- –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é: –º—è–≥–∫–∏–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π (—Å—Å—ã–ª–∫–∞, —Ç–µ–ª–µ—Ñ–æ–Ω, –æ–Ω–ª–∞–π–Ω-—á–∞—Ç).

8. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä.
- –ù–µ –ø–∏—Å–∞—Ç—å –æ —Å–∫–∏–¥–∫–∞—Ö, –∞–∫—Ü–∏—è—Ö, –∏–ø–æ—Ç–µ–∫–µ –∏ –º–∞—Ç–∫–∞–ø–∏—Ç–∞–ª–µ.
- –£–ø–æ–º—è–Ω—É—Ç—å —É–ª–∏—Ü—É, —Ä–∞–π–æ–Ω, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç—Ç–∞–∂–µ–π, –∫–≤–∞—Ä—Ç–∏—Ä, –ø–∞—Ä–∫–æ–≤–æ—á–Ω—ã—Ö –º–µ—Å—Ç, —Å–∞–¥–∏–∫–æ–≤ –∏ –ø—Ä. –≤ –∂–∏–≤–æ–π —Ñ–æ—Ä–º–µ.
- –ü–æ–¥—á—ë—Ä–∫–∏–≤–∞–π —ç–º–æ—Ü–∏–∏: –∫–æ–º—Ñ–æ—Ä—Ç, —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ, —É–¥–æ–±—Å—Ç–≤–æ, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –≥–æ—Ä–¥–æ—Å—Ç—å –∑–∞ –∂–∏–ª—å—ë.
- –ò—Å–ø–æ–ª—å–∑—É–π –æ–±—Ä–∞–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã: ¬´–∑–¥–µ—Å—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –¥–µ–Ω—å —Å —É–ª—ã–±–∫–∏¬ª, ¬´–≤–∞—à–∏ –¥–µ—Ç–∏ —Ä–∞—Å—Ç—É—Ç –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏¬ª, ¬´–¥–æ–º, –∫–æ—Ç–æ—Ä—ã–π –≥–æ–≤–æ—Ä–∏—Ç –∑–∞ –≤–∞—Å¬ª –∏ —Ç.–ø.
- –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à—Ç–∞–º–ø—ã: ¬´–∫–≤–∞—Ä—Ç–∏—Ä—ã –Ω–∞ –ª—é–±–æ–π –≤–∫—É—Å¬ª, ¬´–æ—Ç–ª–∏—á–Ω–∞—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å¬ª, ¬´—Ä–∞–∑–≤–∏—Ç–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞¬ª.
- –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å emoji.
- –£–±—Ä–∞—Ç—å –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞–∫–∏, –∫–æ—Ç–æ—Ä—ã –Ω–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ —Å—Ç–∞—Ç—å–µ, –∞ —è–≤–ª—è—é—Ç—Å—è –æ—à–∏–±–∫–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –æ—Å—Ç–∞—Ç–∫–æ–º –ø—Ä–æ–≥—Ä–∞–º–Ω–æ–≥–æ –∫–æ–¥–∞.
- –í—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–æ–º–ø–ª–µ–∫—Å–∞ –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ —Å–∫–æ–±–æ–∫, –Ω–∞–ø—Ä–∏–º–µ—Ä: https://ap-r.ru/zhilye-kompleksy/kvartiry-v-novostroykakh/zhk-vse-svoi-vip/, –≥–¥–µ zhk-vse-svoi-vip —ç—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∏ —É –∫–∞–∂–¥–æ–≥–æ –∂–∫ —Å–≤–æ—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è.

9. –í –∫–æ–Ω—Ü–µ –≤—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–æ–≤:
üìû 8-800-550-23-93



*–ó–∞–≥–æ–ª–æ–≤–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–∞* ‚Äî –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤.

*META TITLE* ‚Äî –¥–æ 60 —Å–∏–º–≤–æ–ª–æ–≤.

*META KEYWORDS* ‚Äî –Ω–µ –º–µ–Ω–µ–µ 25 –∫–ª—é—á–µ–≤—ã—Ö —Ñ—Ä–∞–∑ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é.

*META DESCRIPTION* ‚Äî –∫—Ä–∞—Ç–∫–æ–µ, —ë–º–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏ (–¥–æ 300 —Å–∏–º–≤–æ–ª–æ–≤), –Ω–µ –¥–æ–ª–∂–Ω–æ –æ–±—Ä—ã–≤–∞—Ç—å—Å—è.

–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
{prompt_text}

–û—Ç–≤–µ—Ç –≤–µ—Ä–Ω–∏ —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

===ELEMENT_NAME===
{{–∑–∞–≥–æ–ª–æ–≤–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–∞}}

===META_TITLE===
{{–º–µ—Ç–∞ —Ç–∞–π—Ç–ª}}

===META_KEYWORDS===
{{–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞}}

===META_DESCRIPTION===
{{–º–µ—Ç–∞ –æ–ø–∏—Å–∞–Ω–∏–µ}}

===ARTICLE===
{{–ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏}}
"""

        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[{"role": "user", "content": full_prompt}],
            temperature=1
        )

        content = response.choices[0].message.content.strip()

        def extract_block(tag):
            match = re.search(rf"==={tag}===\s*(.+?)(?=(?:===|$))", content, re.DOTALL)
            return match.group(1).strip() if match else ""

        result = {
            "element_name": extract_block("ELEMENT_NAME"),
            "meta_title": extract_block("META_TITLE"),
            "meta_keywords": extract_block("META_KEYWORDS"),
            "meta_description": extract_block("META_DESCRIPTION"),
            "article": extract_block("ARTICLE")
        }

        return jsonify(result)

    except Exception as e:
        return jsonify({"error": str(e)}), 500

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=10000)
